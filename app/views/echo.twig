{% extends 'layout.twig' %}

{% block content %}
    <h1>{{ title }}</h1>

    <div class="mtop20 mbottom20">
        <div id="loader" class="center-block">
            <div id="loader_1" class="loader"></div>
        </div>

        <div id="result"></div>
    </div>

    <script type="text/javascript">
        var connection = new WebSocket('ws://{{ ip }}:{{ port }}');
        connection.onopen = function(e) {
            console.debug('start');

            connection.send(JSON.stringify({cmd: 'echo'}))
        };
        connection.onmessage = function(e) {
            var statistic = {};

            try {
                statistic = JSON.parse(e.data);
            } catch (e) {
            }

            if (!!statistic.finished) {
                var $table = $($('#statistic-template').html());

                $table.find('.name').text(statistic.name);
                $table.find('.count').text(formatNumber(statistic.count, 0));
                $table.find('.length').text(formatNumber(statistic.dataLength, 0));
                $table.find('.first').text(formatNumber(statistic.firstValue));
                $table.find('.last').text(formatNumber(statistic.lastValue));
                $table.find('.min').text(formatNumber(statistic.min));
                $table.find('.max').text(formatNumber(statistic.max));
                $table.find('.sum').text(formatNumber(statistic.sum));
                $table.find('.avg').text(formatNumber(statistic.avg));

                $('#result').prepend($table);

                if (!!statistic.last) {
                    $('#loader').hide();
                }
            } else {
                connection.send(e.data);
            }
        };

        function formatNumber(number, fixed) {
            if (fixed === undefined) {
                fixed = 2;
            }

            var number = number.toFixed(fixed) + '';
            var x = number.split('.');
            var x1 = x[0];
            var x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + ',' + '$2');
            }
            return x1 + x2;
        }
    </script>

    <script id="statistic-template" type="text/template">
        <div class="statistic-item">
            <h2 class="name"></h2>
            <table class="table table-hover">
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                </tr>
                <tr>
                    <td>Data Length:</td>
                    <td><span class="length"></span></td>
                </tr>
                <tr>
                    <td>Count:</td>
                    <td><span class="count"></span></td>
                </tr>
                <tr>
                    <td>First:</td>
                    <td><span class="first"></span> ns</td>
                </tr>
                <tr>
                    <td>Last:</td>
                    <td><span class="last"></span> ns</td>
                </tr>
                <tr>
                    <td>Min:</td>
                    <td><span class="min"></span> ns</td>
                </tr>
                <tr>
                    <td>Max:</td>
                    <td><span class="max"></span> ns</td>
                </tr>
                <tr>
                    <td>Sum:</td>
                    <td><span class="sum"></span> ns</td>
                </tr>
                <tr>
                    <td>Average:</td>
                    <td><span class="avg"></span> ns</td>
                </tr>
            </table>
        </div>
    </script>
{% endblock %}
